const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-D9Vj61lL.js","assets/index-Diz4JYK5.js","assets/index--xIqwzj-.css","assets/main-C34UmSl9.js"])))=>i.map(i=>d[i]);
import{$ as e,A as t,O as n,W as r,X as i,_ as a,a9 as o,aM as s,aN as c,aO as l,aX as u,aY as d,aa as ee,al as f,am as p,ap as m,as as te,bB as ne,bC as re,bD as ie,bb as ae,bc as oe,bp as h,bq as se,br as g,bs as ce,bt as le,bu as ue,bz as de,cK as fe,cL as pe,cR as me,cS as he,dA as ge,dL as _e,dM as ve,dl as ye,dm as be,dz as xe,eQ as Se,eR as Ce,eS as we,eT as Te,eU as Ee,eV as De,f3 as Oe,f4 as ke,f6 as Ae,f7 as je,fB as Me,fC as Ne,fb as _,fc as Pe,ff as Fe,fg as Ie,fh as Le,fi as Re,fj as ze,fm as Be,fn as Ve,fo as He,fp as Ue,fq as We,fr as Ge,gI as v,gJ as y,gM as Ke,gR as b,gS as qe,gU as Je,gb as Ye,gd as Xe,ge as Ze,gf as Qe,gg as x,gh as $e,gi as S,gj as et,gq as C,gr as w,h2 as tt,hB as nt,hC as rt,ha as it,hd as at,ho as ot,hq as st,i7 as T,i8 as ct,iG as lt,iH as E,iI as D,iJ as O,iK as k,iN as ut,iO as dt,iR as ft,iS as pt,im as A,in as mt,io as ht,ip as gt,iq as _t,ir as vt,is as yt,jA as j,jB as bt,jI as xt,jJ as St,jK as Ct,jM as wt,jO as Tt,jP as Et,jQ as Dt,jR as Ot,jS as M,jU as N,jY as P,jZ as kt,je as At,jg as jt,jh as Mt,ji as Nt,jj as Pt,jk as F,jl as Ft,jm as It,jn as Lt,jq as Rt,jw as zt,jz as I,k2 as Bt,k4 as Vt,kc as Ht,kd as Ut,kf as Wt,kh as Gt,kj as L,kk as R,kl as z,kn as B}from"./index-Diz4JYK5.js";import{b as Kt,d as qt,g as V}from"./tokenClassificationRegistry-BGMbMr0o.js";oe(),se(),ue(),pe(),he(),be(),ve(),ke(),Pe(),Ve(),Ge(),Ne(),et(),w(),y(),tt(),st(),ct(),A(),mt(),gt(),yt(),dt(),pt(),At(),F(),Lt(),Rt(),I(),St(),Ot(),Bt(),Ut(),Wt(),z(),wt(),P(),Et(),k(),$e();var Jt=class extends M{constructor(e,t,n,r,i,a,o){super(),this._grammar=e,this._initialState=t,this._containsEmbeddedLanguages=n,this._createBackgroundTokenizer=r,this._backgroundTokenizerShouldOnlyVerifyTokens=i,this._reportTokenizationTime=a,this._reportSlowTokenization=o,this._seenLanguages=[],this._onDidEncounterLanguage=this._register(new Ct),this.onDidEncounterLanguage=this._onDidEncounterLanguage.event}get backgroundTokenizerShouldOnlyVerifyTokens(){return this._backgroundTokenizerShouldOnlyVerifyTokens()}getInitialState(){return this._initialState}tokenize(e,t,n){throw Error(`Not supported!`)}createBackgroundTokenizer(e,t){if(this._createBackgroundTokenizer)return this._createBackgroundTokenizer(e,t)}tokenizeEncoded(e,t,n){let r=Math.random()*1e4<1,i=this._reportSlowTokenization||r,a=i?new Tt(!0):void 0,o=this._grammar.tokenizeLine2(e,n,500);if(i){let t=a.elapsed();(r||t>32)&&this._reportTokenizationTime(t,e.length,r)}if(o.stoppedEarly)return console.warn(`Time limit reached when tokenizing line: ${e.substring(0,100)}`),new Ze(o.tokens,n);if(this._containsEmbeddedLanguages){let e=this._seenLanguages,t=o.tokens;for(let n=0,r=t.length>>>1;n<r;n++){let r=t[(n<<1)+1],i=O.getLanguageId(r);e[i]||(e[i]=!0,this._onDidEncounterLanguage.fire(i))}}let s;return s=n.equals(o.ruleStack)?n:o.ruleStack,new Ze(o.tokens,s)}};Ye(),P();var Yt=class extends M{get backgroundTokenizerShouldOnlyVerifyTokens(){return this._actual.backgroundTokenizerShouldOnlyVerifyTokens}constructor(e,t,n,r){super(),this._encodedLanguageId=e,this._actual=t,this._maxTokenizationLineLength=r,this._register(ht(this._maxTokenizationLineLength)),this._register(n)}getInitialState(){return this._actual.getInitialState()}tokenize(e,t,n){throw Error(`Not supported!`)}tokenizeEncoded(e,t,n){return e.length>=this._maxTokenizationLineLength.get()?Xe(this._encodedLanguageId,n):this._actual.tokenizeEncoded(e,t,n)}createBackgroundTokenizer(e,t){if(this._actual.createBackgroundTokenizer)return this._actual.createBackgroundTokenizer(e,t)}},Xt=class e{static{this.CHANNEL_NAME=`textMateWorkerHost`}static getChannel(t){return t.getChannel(e.CHANNEL_NAME)}static setChannel(t,n){t.setChannel(e.CHANNEL_NAME,n)}};o(),Te(),De(),Ue();var Zt=class e{static fromMany(t){let n=t.map(t=>new e(t));return new Qt(n)}constructor(e){this.transformation=e,this.idx=0,this.offset=0}transform(e){let t=this.transformation.replacements.at(this.idx);for(;t&&t.replaceRange.endExclusive<=e;)this.offset+=t.getLengthDelta(),this.idx++,t=this.transformation.replacements.at(this.idx);if(!(t&&t.replaceRange.start<=e))return e+this.offset}},Qt=class{constructor(e){this.transformers=e}transform(e){for(let t of this.transformers){let n=t.transform(e);if(n===void 0)return;e=n}return e}};P(),A(),r(),mt(),d();var $t=class e extends M{static{this._id=0}constructor(t,n,r,i,a,o){super(),this._model=t,this._worker=n,this._languageIdCodec=r,this._backgroundTokenizationStore=i,this._configurationService=a,this._maxTokenizationLineLength=o,this.controllerId=e._id++,this._pendingChanges=[],this._states=new we,this._loggingEnabled=ee(`editor.experimental.asyncTokenizationLogging`,!1,this._configurationService),this._register(ht(this._loggingEnabled)),this._register(this._model.onDidChangeContent(e=>{this._shouldLog&&console.log(`model change`,{fileName:this._model.uri.fsPath.split(`\\`).pop(),changes:H(e.changes)}),this._worker.$acceptModelChanged(this.controllerId,e),this._pendingChanges.push(e)})),this._register(this._model.onDidChangeLanguage(e=>{let t=this._model.getLanguageId(),n=this._languageIdCodec.encodeLanguageId(t);this._worker.$acceptModelLanguageChanged(this.controllerId,t,n)}));let s=this._model.getLanguageId(),c=this._languageIdCodec.encodeLanguageId(s);this._worker.$acceptNewModel({uri:this._model.uri,versionId:this._model.getVersionId(),lines:this._model.getLinesContent(),EOL:this._model.getEOL(),languageId:s,encodedLanguageId:c,maxTokenizationLineLength:this._maxTokenizationLineLength.get(),controllerId:this.controllerId}),this._register(vt(e=>{let t=this._maxTokenizationLineLength.read(e);this._worker.$acceptMaxTokenizationLineLength(this.controllerId,t)}))}dispose(){super.dispose(),this._worker.$acceptRemovedModel(this.controllerId)}requestTokens(e,t){this._worker.$retokenize(this.controllerId,e,t)}async setTokensAndStates(e,t,n,r){if(this.controllerId!==e)return;let a=Ee.deserialize(new Uint8Array(n));if(this._shouldLog&&console.log(`received background tokenization result`,{fileName:this._model.uri.fsPath.split(`\\`).pop(),updatedTokenLines:a.map(e=>e.getLineRange()).join(` & `),updatedStateLines:r.map(e=>new He(e.startLineNumber,e.startLineNumber+e.stateDeltas.length).toString()).join(` & `)}),this._shouldLog){let e=this._pendingChanges.filter(e=>e.versionId<=t).map(e=>e.changes).map(e=>H(e)).join(` then `);console.log(`Applying changes to local states`,e)}for(;this._pendingChanges.length>0&&this._pendingChanges[0].versionId<=t;){let e=this._pendingChanges.shift();this._states.acceptChanges(e.changes)}if(this._pendingChanges.length>0){if(this._shouldLog){let e=this._pendingChanges.map(e=>e.changes).map(e=>H(e)).join(` then `);console.log(`Considering non-processed changes`,e)}let e=Zt.fromMany(this._pendingChanges.map(e=>i(e.changes))),t=new Ee;for(let n of a)for(let r=n.startLineNumber;r<=n.endLineNumber;r++){let i=e.transform(r-1);i!==void 0&&t.add(r,n.getLineTokens(r))}a=t.finalize();for(let e of this._pendingChanges)for(let t of e.changes)for(let e=0;e<a.length;e++)a[e].applyEdit(t.range,t.text)}let o=Zt.fromMany(this._pendingChanges.map(e=>i(e.changes)));if(!this._applyStateStackDiffFn||!this._initialState){let{applyStateStackDiff:e,INITIAL:t}=await u(()=>import(`./main-D9Vj61lL.js`).then(B()),__vite__mapDeps([0,1,2])).then(e=>e.default??e);this._applyStateStackDiffFn=e,this._initialState=t}for(let e of r){let t=e.startLineNumber<=1?this._initialState:this._states.getEndState(e.startLineNumber-1);for(let n=0;n<e.stateDeltas.length;n++){let r=e.stateDeltas[n],i;r?(i=this._applyStateStackDiffFn(t,r),this._states.setEndState(e.startLineNumber+n,i)):i=this._states.getEndState(e.startLineNumber+n);let a=o.transform(e.startLineNumber+n-1);a!==void 0&&this._backgroundTokenizationStore.setEndState(a+1,i),e.startLineNumber+n>=this._model.getLineCount()-1&&this._backgroundTokenizationStore.backgroundTokenizationFinished(),t=i}}this._backgroundTokenizationStore.setTokens(a)}get _shouldLog(){return this._loggingEnabled.get()}};function H(e){return e.map(e=>S.lift(e.range).toString()+` => `+e.text).join(` & `)}P(),ge();var U;let W=class{static{U=this}static{this._reportedMismatchingTokens=!1}constructor(e,t,n,r,i,a,o){this._reportTokenizationTime=e,this._shouldTokenizeAsync=t,this._extensionResourceLoaderService=n,this._configurationService=r,this._languageService=i,this._notificationService=a,this._telemetryService=o,this._workerProxyPromise=null,this._worker=null,this._workerProxy=null,this._workerTokenizerControllers=new Map,this._currentTheme=null,this._currentTokenColorMap=null,this._grammarDefinitions=[]}dispose(){this._disposeWorker()}createBackgroundTokenizer(e,t,n){if(!this._shouldTokenizeAsync()||e.isTooLargeForSyncing())return;let r=new N,i=this._getWorkerProxy().then(i=>{if(r.isDisposed||!i)return;let a={controller:void 0,worker:this._worker};return r.add(en(e,()=>{let r=new $t(e,i,this._languageService.languageIdCodec,t,this._configurationService,n);return a.controller=r,this._workerTokenizerControllers.set(r.controllerId,r),kt(()=>{a.controller=void 0,this._workerTokenizerControllers.delete(r.controllerId),r.dispose()})})),a});return{dispose(){r.dispose()},requestTokens:async(e,t)=>{let n=await i;n?.controller&&n.worker===this._worker&&n.controller.requestTokens(e,t)},reportMismatchingTokens:e=>{U._reportedMismatchingTokens||(U._reportedMismatchingTokens=!0,this._notificationService.error({message:`Async Tokenization Token Mismatch in line `+e,name:`Async Tokenization Token Mismatch`}),this._telemetryService.publicLog2(`asyncTokenizationMismatchingTokens`,{}))}}}setGrammarDefinitions(e){this._grammarDefinitions=e,this._disposeWorker()}acceptTheme(e,t){this._currentTheme=e,this._currentTokenColorMap=t,this._currentTheme&&this._currentTokenColorMap&&this._workerProxy&&this._workerProxy.$acceptTheme(this._currentTheme,this._currentTokenColorMap)}_getWorkerProxy(){return this._workerProxyPromise||=this._createWorkerProxy(),this._workerProxyPromise}async _createWorkerProxy(){let e={grammarDefinitions:this._grammarDefinitions,onigurumaWASMUri:new URL(`/typst-playground/assets/onig-Du5pRr7Y.wasm`,``+import.meta.url).href},t=this._worker=xe(Nt.asBrowserUri(`vs/workbench/services/textMate/browser/backgroundTokenization/worker/textMateTokenizationWorker.workerMain.js`),`TextMateWorker`);return Xt.setChannel(t,{$readFile:async e=>{let t=It.revive(e);return this._extensionResourceLoaderService.readExtensionResource(t)},$setTokensAndStates:async(e,t,n,r)=>{let i=this._workerTokenizerControllers.get(e);i&&i.setTokensAndStates(e,t,n,r)},$reportTokenizationTime:(e,t,n,r,i)=>{this._reportTokenizationTime(e,t,n,r,i)}}),await t.proxy.$init(e),this._worker===t?(this._workerProxy=t.proxy,this._currentTheme&&this._currentTokenColorMap&&this._workerProxy.$acceptTheme(this._currentTheme,this._currentTokenColorMap),t.proxy):null}_disposeWorker(){for(let e of this._workerTokenizerControllers.values())e.dispose();this._workerTokenizerControllers.clear(),this._worker&&=(this._worker.dispose(),null),this._workerProxy=null,this._workerProxyPromise=null}};W=U=L([R(2,fe),R(3,v),R(4,C),R(5,_),R(6,We)],W);function en(e,t){let n=new N,r=n.add(new N);function i(){e.isAttachedToEditor()?r.add(t()):r.clear()}return i(),n.add(e.onDidChangeAttached(()=>{i()})),n}var tn=class{constructor(){this._scopeNameToLanguageRegistration=Object.create(null)}reset(){this._scopeNameToLanguageRegistration=Object.create(null)}register(e){this._scopeNameToLanguageRegistration[e.scopeName]=e}getGrammarDefinition(e){return this._scopeNameToLanguageRegistration[e]||null}};P();const G=`No TM Grammar registered for this language.`;var nn=class extends M{constructor(e,t,n,r){super(),this._host=e,this._initialState=n.INITIAL,this._scopeRegistry=new tn,this._injections={},this._injectedEmbeddedLanguages={},this._languageToScope=new Map,this._grammarRegistry=this._register(new n.Registry({onigLib:r,loadGrammar:async e=>{let t=this._scopeRegistry.getGrammarDefinition(e);if(!t)return this._host.logTrace(`No grammar found for scope ${e}`),null;let r=t.location;try{let e=await this._host.readFile(r);return n.parseRawGrammar(e,r.path)}catch(t){return this._host.logError(`Unable to load and parse grammar for scope ${e} from ${r}`,t),null}},getInjections:e=>{let t=e.split(`.`),n=[];for(let e=1;e<=t.length;e++){let r=t.slice(0,e).join(`.`);n=[...n,...this._injections[r]||[]]}return n}}));for(let e of t){if(this._scopeRegistry.register(e),e.injectTo){for(let t of e.injectTo){let n=this._injections[t];n||(this._injections[t]=n=[]),n.push(e.scopeName)}if(e.embeddedLanguages)for(let t of e.injectTo){let n=this._injectedEmbeddedLanguages[t];n||(this._injectedEmbeddedLanguages[t]=n=[]),n.push(e.embeddedLanguages)}}e.language&&this._languageToScope.set(e.language,e.scopeName)}}has(e){return this._languageToScope.has(e)}setTheme(e,t){this._grammarRegistry.setTheme(e,t)}getColorMap(){return this._grammarRegistry.getColorMap()}async createGrammar(e,t){let n=this._languageToScope.get(e);if(typeof n!=`string`)throw Error(G);let r=this._scopeRegistry.getGrammarDefinition(n);if(!r)throw Error(G);let i=r.embeddedLanguages;if(this._injectedEmbeddedLanguages[n]){let e=this._injectedEmbeddedLanguages[n];for(let t of e)for(let e of Object.keys(t))i[e]=t[e]}let a=Object.keys(i).length>0,o;try{o=await this._grammarRegistry.loadGrammarWithConfiguration(n,t,{embeddedLanguages:i,tokenTypes:r.tokenTypes,balancedBracketSelectors:r.balancedBracketSelectors,unbalancedBracketSelectors:r.unbalancedBracketSelectors})}catch(e){throw e.message&&e.message.startsWith(`No grammar provided for`)?Error(G):e}return{languageId:e,grammar:o,initialState:this._initialState,containsEmbeddedLanguages:a,sourceExtensionId:r.sourceExtensionId}}};ce(),a();const K=g.registerExtensionPoint({extensionPoint:`grammars`,deps:[e],jsonSchema:{description:j(13410,`Contributes textmate tokenizers.`),type:`array`,defaultSnippets:[{body:[{language:"${1:id}",scopeName:"source.${2:id}",path:"./syntaxes/${3:id}.tmLanguage."}]}],items:{type:`object`,defaultSnippets:[{body:{language:"${1:id}",scopeName:"source.${2:id}",path:"./syntaxes/${3:id}.tmLanguage."}}],properties:{language:{description:j(13411,`Language identifier for which this syntax is contributed to.`),type:`string`},scopeName:{description:j(13412,`Textmate scope name used by the tmLanguage file.`),type:`string`},path:{description:j(13413,`Path of the tmLanguage file. The path is relative to the extension folder and typically starts with './syntaxes/'.`),type:`string`},embeddedLanguages:{description:j(13414,`A map of scope name to language id if this grammar contains embedded languages.`),type:`object`},tokenTypes:{description:j(13415,`A map of scope name to token types.`),type:`object`,additionalProperties:{enum:[`string`,`comment`,`other`]}},injectTo:{description:j(13416,`List of language scope names to which this grammar is injected to.`),type:`array`,items:{type:`string`}},balancedBracketScopes:{description:j(13417,`Defines which scope names contain balanced brackets.`),type:`array`,items:{type:`string`},default:[`*`]},unbalancedBracketScopes:{description:j(13418,`Defines which scope names do not contain balanced brackets.`),type:`array`,items:{type:`string`},default:[]}},required:[`scopeName`,`path`]}}});z(),P(),F(),A(),k(),$e(),w(),I(),y(),pe(),Pe(),Ge(),d();var q;let J=class extends M{static{q=this}static{this.reportTokenizationTimeCounter={sync:0,async:0}}constructor(e,t,n,r,i,a,o,s,c,l){super(),this._languageService=e,this._themeService=t,this._extensionResourceLoaderService=n,this._notificationService=r,this._logService=i,this._configurationService=a,this._progressService=o,this._environmentService=s,this._instantiationService=c,this._telemetryService=l,this._createdModes=[],this._encounteredLanguages=[],this._debugMode=!1,this._debugModePrintFunc=()=>{},this._grammarDefinitions=null,this._grammarFactory=null,this._tokenizersRegistrations=this._register(new N),this._currentTheme=null,this._currentTokenColorMap=null,this._threadedBackgroundTokenizerFactory=this._instantiationService.createInstance(W,(e,t,n,r,i)=>this._reportTokenizationTime(e,t,n,r,!0,i),()=>this.getAsyncTokenizationEnabled()),this._vscodeOniguruma=null,this._styleElement=Oe(),this._styleElement.className=`vscode-tokens-styles`,K.setHandler(e=>this._handleGrammarsExtPoint(e)),this._updateTheme(this._themeService.getColorTheme(),!0),this._register(this._themeService.onDidColorThemeChange(()=>{this._updateTheme(this._themeService.getColorTheme(),!1)})),this._register(this._languageService.onDidRequestRichLanguageFeatures(e=>{this._createdModes.push(e)}))}getAsyncTokenizationEnabled(){return!!this._configurationService.getValue(`editor.experimental.asyncTokenization`)}getAsyncTokenizationVerification(){return!!this._configurationService.getValue(`editor.experimental.asyncTokenizationVerification`)}_handleGrammarsExtPoint(e){this._grammarDefinitions=null,this._grammarFactory&&=(this._grammarFactory.dispose(),null),this._tokenizersRegistrations.clear(),this._grammarDefinitions=[];for(let t of e){let e=t.value;for(let n of e){let e=this._validateGrammarDefinition(t,n);if(e&&(this._grammarDefinitions.push(e),e.language)){let t=new Qe(()=>this._createTokenizationSupport(e.language));this._tokenizersRegistrations.add(t),this._tokenizersRegistrations.add(x.registerFactory(e.language,t))}}}this._threadedBackgroundTokenizerFactory.setGrammarDefinitions(this._grammarDefinitions);for(let e of this._createdModes)x.getOrCreate(e)}_validateGrammarDefinition(e,t){if(!on(e.description.extensionLocation,t,e.collector,this._languageService))return null;let n=Mt(e.description.extensionLocation,t.path),r=Object.create(null);if(t.embeddedLanguages){let e=Object.keys(t.embeddedLanguages);for(let n=0,i=e.length;n<i;n++){let i=e[n],a=t.embeddedLanguages[i];typeof a==`string`&&this._languageService.isRegisteredLanguageId(a)&&(r[i]=this._languageService.languageIdCodec.encodeLanguageId(a))}}let i=Object.create(null);if(t.tokenTypes){let e=Object.keys(t.tokenTypes);for(let n of e){let e=t.tokenTypes[n];switch(e){case`string`:i[n]=D.String;break;case`other`:i[n]=D.Other;break;case`comment`:i[n]=D.Comment;break}}}let a=t.language&&this._languageService.isRegisteredLanguageId(t.language)?t.language:void 0;function o(e,t){return!Array.isArray(e)||!e.every(e=>typeof e==`string`)?t:e}return{location:n,language:a,scopeName:t.scopeName,embeddedLanguages:r,tokenTypes:i,injectTo:t.injectTo,balancedBracketSelectors:o(t.balancedBracketScopes,[`*`]),unbalancedBracketSelectors:o(t.unbalancedBracketScopes,[]),sourceExtensionId:e.description.id}}startDebugMode(e,t){if(this._debugMode){this._notificationService.error(j(13399,`Already Logging.`));return}this._debugModePrintFunc=e,this._debugMode=!0,this._debugMode&&this._progressService.withProgress({location:ae.Notification,buttons:[j(13400,`Stop`)]},e=>(e.report({message:j(13401,`Preparing to log TM Grammar parsing. Press Stop when finished.`)}),this._getVSCodeOniguruma().then(t=>(t.setDefaultDebugCall(!0),e.report({message:j(13402,`Now logging TM Grammar parsing. Press Stop when finished.`)}),new Promise((e,t)=>{})))),e=>{this._getVSCodeOniguruma().then(e=>{this._debugModePrintFunc=()=>{},this._debugMode=!1,e.setDefaultDebugCall(!1),t()})})}_canCreateGrammarFactory(){return!!this._grammarDefinitions}async _getOrCreateGrammarFactory(){if(this._grammarFactory)return this._grammarFactory;let[e,t]=await Promise.all([u(()=>import(`./main-D9Vj61lL.js`).then(B()),__vite__mapDeps([0,1,2])).then(e=>e.default??e),this._getVSCodeOniguruma()]),n=Promise.resolve({createOnigScanner:e=>t.createOnigScanner(e),createOnigString:e=>t.createOnigString(e)});return this._grammarFactory?this._grammarFactory:(this._grammarFactory=new nn({logTrace:e=>this._logService.trace(e),logError:(e,t)=>this._logService.error(e,t),readFile:e=>this._extensionResourceLoaderService.readExtensionResource(e)},this._grammarDefinitions||[],e,n),this._updateTheme(this._themeService.getColorTheme(),!0),this._grammarFactory)}async _createTokenizationSupport(e){if(!this._languageService.isRegisteredLanguageId(e)||!this._canCreateGrammarFactory())return null;try{let t=await this._getOrCreateGrammarFactory();if(!t.has(e))return null;let n=this._languageService.languageIdCodec.encodeLanguageId(e),r=await t.createGrammar(e,n);if(!r.grammar)return null;let i=sn(`editor.maxTokenizationLineLength`,e,-1,this._configurationService),a=new N,o=a.add(new Jt(r.grammar,r.initialState,r.containsEmbeddedLanguages,(e,t)=>this._threadedBackgroundTokenizerFactory.createBackgroundTokenizer(e,t,i),()=>this.getAsyncTokenizationVerification(),(t,n,i)=>{this._reportTokenizationTime(t,e,r.sourceExtensionId,n,!1,i)},!0));return a.add(o.onDidEncounterLanguage(e=>{if(!this._encounteredLanguages[e]){let t=this._languageService.languageIdCodec.decodeLanguageId(e);this._encounteredLanguages[e]=!0,this._languageService.requestBasicLanguageFeatures(t)}})),new Yt(n,o,a,i)}catch(e){return e.message&&e.message===G||Gt(e),null}}_updateTheme(e,t){if(!t&&this._currentTheme&&this._currentTokenColorMap&&an(this._currentTheme.settings,e.tokenColors)&&Ht(this._currentTokenColorMap,e.tokenColorMap))return;this._currentTheme={name:e.label,settings:e.tokenColors},this._currentTokenColorMap=e.tokenColorMap,this._grammarFactory?.setTheme(this._currentTheme,this._currentTokenColorMap);let n=rn(this._currentTokenColorMap),r=ye(n);this._styleElement.textContent=r,x.setColorMap(n),this._currentTheme&&this._currentTokenColorMap&&this._threadedBackgroundTokenizerFactory.acceptTheme(this._currentTheme,this._currentTokenColorMap)}async createTokenizer(e){if(!this._languageService.isRegisteredLanguageId(e))return null;let t=await this._getOrCreateGrammarFactory();if(!t.has(e))return null;let n=this._languageService.languageIdCodec.encodeLanguageId(e),{grammar:r}=await t.createGrammar(e,n);return r}_getVSCodeOniguruma(){return this._vscodeOniguruma||=(async()=>{let[e,t]=await Promise.all([u(()=>import(`./main-C34UmSl9.js`).then(B()),__vite__mapDeps([3,1,2])).then(e=>e.default??e),this._loadVSCodeOnigurumaWASM()]);return await e.loadWASM({data:t,print:e=>{this._debugModePrintFunc(e)}}),e})(),this._vscodeOniguruma}async _loadVSCodeOnigurumaWASM(){if(zt){let e=await fetch(new URL(`/typst-playground/assets/onig-Du5pRr7Y.wasm`,``+import.meta.url).href);return await e.arrayBuffer()}else{let e=await fetch(Nt.asBrowserUri(`${Ft}/vscode-oniguruma/release/onig.wasm`).toString(!0));return e}}_reportTokenizationTime(e,t,n,r,i,a){let o=i?`async`:`sync`;q.reportTokenizationTimeCounter[o]>50||(q.reportTokenizationTimeCounter[o]===0&&setTimeout(()=>{q.reportTokenizationTimeCounter[o]=0},1e3*60*60),q.reportTokenizationTimeCounter[o]++,this._telemetryService.publicLog2(`editor.tokenizedLine`,{timeMs:e,languageId:t,lineLength:r,fromWorker:i,sourceExtensionId:n,isRandomSample:a,tokenizationSetting:this.getAsyncTokenizationEnabled()?this.getAsyncTokenizationVerification()?2:1:0}))}};J=q=L([R(0,C),R(1,t),R(2,fe),R(3,_),R(4,Me),R(5,v),R(6,_e),R(7,le),R(8,ut),R(9,We)],J);function rn(e){let t=[null];for(let n=1,r=e.length;n<r;n++)t[n]=T.fromHex(e[n]);return t}function an(e,t){if(!t||!e||t.length!==e.length)return!1;for(let n=t.length-1;n>=0;n--){let r=t[n],i=e[n];if(r.scope!==i.scope)return!1;let a=r.settings,o=i.settings;if(a&&o){if(a.fontStyle!==o.fontStyle||a.foreground!==o.foreground||a.background!==o.background)return!1}else if(!a||!o)return!1}return!0}function on(e,t,n,r){if(t.language&&(typeof t.language!=`string`||!r.isRegisteredLanguageId(t.language)))return n.error(j(13403,"Unknown language in `contributes.{0}.language`. Provided value: {1}",K.name,String(t.language))),!1;if(!t.scopeName||typeof t.scopeName!=`string`)return n.error(j(13404,"Expected string in `contributes.{0}.scopeName`. Provided value: {1}",K.name,String(t.scopeName))),!1;if(!t.path||typeof t.path!=`string`)return n.error(j(13405,"Expected string in `contributes.{0}.path`. Provided value: {1}",K.name,String(t.path))),!1;if(t.injectTo&&(!Array.isArray(t.injectTo)||t.injectTo.some(e=>typeof e!=`string`)))return n.error(j(13406,"Invalid value in `contributes.{0}.injectTo`. Must be an array of language scope names. Provided value: {1}",K.name,JSON.stringify(t.injectTo))),!1;if(t.embeddedLanguages&&!Vt(t.embeddedLanguages))return n.error(j(13407,"Invalid value in `contributes.{0}.embeddedLanguages`. Must be an object map from scope name to language. Provided value: {1}",K.name,JSON.stringify(t.embeddedLanguages))),!1;if(t.tokenTypes&&!Vt(t.tokenTypes))return n.error(j(13408,"Invalid value in `contributes.{0}.tokenTypes`. Must be an object map from scope name to token type. Provided value: {1}",K.name,JSON.stringify(t.tokenTypes))),!1;let i=Mt(e,t.path);return jt(i,e)||n.warn(j(13409,"Expected `contributes.{0}.path` ({1}) to be included inside extension's folder ({2}). This might make the extension non-portable.",K.name,i.path,e.path)),!0}function sn(e,t,n,r){return _t(n=>r.onDidChangeConfiguration(r=>{r.affectsConfiguration(e,{overrideIdentifier:t})&&n(r)}),()=>r.getValue(e,{overrideIdentifier:t})??n)}p(),m(),ne(),ie(),z(),I(),ce(),c(),dt();const Y=qt(),cn=g.registerExtensionPoint({extensionPoint:`semanticTokenTypes`,jsonSchema:{description:j(13606,`Contributes semantic token types.`),type:`array`,items:{type:`object`,properties:{id:{type:`string`,description:j(13607,`The identifier of the semantic token type`),pattern:V,patternErrorMessage:j(13608,`Identifiers should be in the form letterOrDigit[_-letterOrDigit]*`)},superType:{type:`string`,description:j(13609,`The super type of the semantic token type`),pattern:V,patternErrorMessage:j(13610,`Super types should be in the form letterOrDigit[_-letterOrDigit]*`)},description:{type:`string`,description:j(13611,`The description of the semantic token type`)}}}}}),ln=g.registerExtensionPoint({extensionPoint:`semanticTokenModifiers`,jsonSchema:{description:j(13612,`Contributes semantic token modifiers.`),type:`array`,items:{type:`object`,properties:{id:{type:`string`,description:j(13613,`The identifier of the semantic token modifier`),pattern:V,patternErrorMessage:j(13614,`Identifiers should be in the form letterOrDigit[_-letterOrDigit]*`)},description:{type:`string`,description:j(13615,`The description of the semantic token modifier`)}}}}}),un=g.registerExtensionPoint({extensionPoint:`semanticTokenScopes`,jsonSchema:{description:j(13616,`Contributes semantic token scope maps.`),type:`array`,items:{type:`object`,properties:{language:{description:j(13617,`Lists the languge for which the defaults are.`),type:`string`},scopes:{description:j(13618,`Maps a semantic token (described by semantic token selector) to one or more textMate scopes used to represent that token.`),type:`object`,additionalProperties:{type:`array`,items:{type:`string`}}}}}}});var dn=class{constructor(){function e(e,t,n){if(typeof e.id!=`string`||e.id.length===0)return n.error(j(13619,`'configuration.{0}.id' must be defined and can not be empty`,t)),!1;if(!e.id.match(V))return n.error(j(13620,`'configuration.{0}.id' must follow the pattern letterOrDigit[-_letterOrDigit]*`,t)),!1;let r=e.superType;return r&&!r.match(V)?(n.error(j(13621,`'configuration.{0}.superType' must follow the pattern letterOrDigit[-_letterOrDigit]*`,t)),!1):typeof e.description!=`string`||e.id.length===0?(n.error(j(13622,`'configuration.{0}.description' must be defined and can not be empty`,t)),!1):!0}cn.setHandler((t,n)=>{for(let t of n.added){let n=t.value,r=t.collector;if(!n||!Array.isArray(n)){r.error(j(13623,`'configuration.semanticTokenType' must be an array`));return}for(let t of n)e(t,`semanticTokenType`,r)&&Y.registerTokenType(t.id,t.description,t.superType)}for(let e of n.removed){let t=e.value;for(let e of t)Y.deregisterTokenType(e.id)}}),ln.setHandler((t,n)=>{for(let t of n.added){let n=t.value,r=t.collector;if(!n||!Array.isArray(n)){r.error(j(13624,`'configuration.semanticTokenModifier' must be an array`));return}for(let t of n)e(t,`semanticTokenModifier`,r)&&Y.registerTokenModifier(t.id,t.description)}for(let e of n.removed){let t=e.value;for(let e of t)Y.deregisterTokenModifier(e.id)}}),un.setHandler((e,t)=>{for(let e of t.added){let t=e.value,n=e.collector;if(!t||!Array.isArray(t)){n.error(j(13625,`'configuration.semanticTokenScopes' must be an array`));return}for(let e of t){if(e.language&&typeof e.language!=`string`){n.error(j(13626,`'configuration.semanticTokenScopes.language' must be a string`));continue}if(!e.scopes||typeof e.scopes!=`object`){n.error(j(13627,`'configuration.semanticTokenScopes.scopes' must be defined as an object`));continue}for(let t in e.scopes){let r=e.scopes[t];if(!Array.isArray(r)||r.some(e=>typeof e!=`string`)){n.error(j(13628,`'configuration.semanticTokenScopes.scopes' values must be an array of strings`));continue}try{let n=Y.parseTokenSelector(t,e.language);Y.registerTokenStyleDefault(n,{scopesToProbe:r.map(e=>e.split(` `))})}catch{n.error(j(13629,`configuration.semanticTokenScopes.scopes': Problems parsing selector {0}.`,t))}}}}for(let e of t.removed){let t=e.value;for(let e of t)for(let t in e.scopes){let n=e.scopes[t];try{let r=Y.parseTokenSelector(t,e.language);Y.registerTokenStyleDefault(r,{scopesToProbe:n.map(e=>e.split(` `))})}catch{}}}})}};let X=class{static{this.ID=`workbench.contrib.tokenClassificationExtensionPoint`}constructor(e){this.instantiationService=e,this.instantiationService.createInstance(dn)}};X=L([R(0,ut)],X),l(X.ID,X,s.BlockStartup),nt();var fn={};je(),Le();function pn(e,t,n=!0){for(let r=t.length-1;r>=0;r--){let i=t.slice(0,r),a=t[r],o=mn(e,a,i,n);if(o)return o}return null}function mn(e,t,n,r){let i=null;for(let a=e.tokenColors.length-1;a>=0;a--){let o=e.tokenColors[a];if(r&&!o.settings.foreground)continue;let s;if(typeof o.scope==`string`)s=o.scope.split(/,/).map(e=>e.trim());else if(Array.isArray(o.scope))s=o.scope;else continue;for(let e=0,r=s.length;e<r;e++){let r=s[e],a=new hn(r,o.settings);a.matches(t,n)&&a.isMoreSpecific(i)&&(i=a)}}return i}var hn=class e{constructor(e,t){this.rawSelector=e,this.settings=t;let n=this.rawSelector.split(/ /);this.scope=n[n.length-1],this.parentScopes=n.slice(0,n.length-1)}matches(t,n){return e._matches(this.scope,this.parentScopes,t,n)}static _cmp(e,t){if(e===null&&t===null)return 0;if(e===null)return-1;if(t===null)return 1;if(e.scope.length!==t.scope.length)return e.scope.length-t.scope.length;let n=e.parentScopes.length,r=t.parentScopes.length;if(n!==r)return n-r;for(let r=0;r<n;r++){let n=e.parentScopes[r].length,i=t.parentScopes[r].length;if(n!==i)return n-i}return 0}isMoreSpecific(t){return e._cmp(this,t)>0}static _matchesOne(e,t){let n=e+`.`;return e===t||t.substring(0,n.length)===n}static _matches(e,t,n,r){if(!this._matchesOne(e,n))return!1;let i=t.length-1,a=r.length-1;for(;i>=0&&a>=0;)this._matchesOne(t[i],r[a])&&i--,a--;return i===-1}};z(),I(),ct(),P(),et(),k(),w(),Pe(),y(),F(),Ce();var Z;rt(fn);const Q=Ke;let $=class extends M{static{Z=this}static{this.ID=`editor.contrib.inspectEditorTokens`}static get(e){return e.getContribution(Z.ID)}constructor(e,t,n,r,i,a,o){super(),this._editor=e,this._textMateService=t,this._themeService=r,this._languageService=n,this._notificationService=i,this._configurationService=a,this._languageFeaturesService=o,this._widget=null,this._register(this._editor.onDidChangeModel(e=>this.stop())),this._register(this._editor.onDidChangeModelLanguage(e=>this.stop())),this._register(this._editor.onKeyUp(e=>e.keyCode===ot.Escape&&this.stop()))}dispose(){this.stop(),super.dispose()}launch(){this._widget||this._editor.hasModel()&&this._editor.getModel().uri.scheme!==Pt.vscodeNotebookCell&&(this._widget=new vn(this._editor,this._textMateService,this._languageService,this._themeService,this._notificationService,this._configurationService,this._languageFeaturesService))}stop(){this._widget&&=(this._widget.dispose(),null)}toggle(){this._widget?this.stop():this.launch()}};$=Z=L([R(1,h),R(2,C),R(3,t),R(4,_),R(5,v),R(6,Be)],$);var gn=class extends Fe{constructor(){super({id:`editor.action.inspectTMScopes`,label:bt(5554,`Developer: Inspect Editor Tokens and Scopes`),precondition:void 0})}run(e,t){let n=$.get(t);n?.toggle()}};function _n(e){e.length>40&&(e=e.substr(0,20)+`…`+e.substr(e.length-20));let t=``;for(let n=0,r=e.length;n<r;n++){let r=e.charCodeAt(n);switch(r){case Dt.Tab:t+=`→`;break;case Dt.Space:t+=`·`;break;default:t+=String.fromCharCode(r)}}return t}var vn=class e extends M{static{this._ID=`editor.contrib.inspectEditorTokensWidget`}constructor(e,t,n,r,i,a,o){super(),this.allowEditorOverflow=!0,this._isDisposed=!1,this._editor=e,this._languageService=n,this._themeService=r,this._textMateService=t,this._notificationService=i,this._configurationService=a,this._languageFeaturesService=o,this._model=this._editor.getModel(),this._domNode=Je(`div`),this._domNode.className=`token-inspect-widget`,this._currentRequestCancellationTokenSource=new xt,this._beginCompute(this._editor.getPosition()),this._register(this._editor.onDidChangeCursorPosition(e=>this._beginCompute(this._editor.getPosition()))),this._register(r.onDidColorThemeChange(e=>this._beginCompute(this._editor.getPosition()))),this._register(a.onDidChangeConfiguration(e=>e.affectsConfiguration(`editor.semanticHighlighting.enabled`)&&this._beginCompute(this._editor.getPosition()))),this._editor.addContentWidget(this)}dispose(){this._isDisposed=!0,this._editor.removeContentWidget(this),this._currentRequestCancellationTokenSource.cancel(),super.dispose()}getId(){return e._ID}_beginCompute(e){let t=this._textMateService.createTokenizer(this._model.getLanguageId()),n=this._computeSemanticTokens(e),r=this._model.tokenization.tokens.get(),i=r instanceof Se?r:void 0;qe(this._domNode),this._domNode.appendChild(document.createTextNode(j(5555,`Loading...`))),Promise.all([t,n]).then(([t,n])=>{if(this._isDisposed)return;let r=i?.tree.get();this._compute(t,n,r,e),this._domNode.style.maxWidth=`${Math.max(this._editor.getLayoutInfo().width*.66,500)}px`,this._editor.layoutContentWidget(this)},e=>{this._notificationService.warn(e),setTimeout(()=>{$.get(this._editor)?.stop()})})}_isSemanticColoringEnabled(){let e=this._configurationService.getValue(n,{overrideIdentifier:this._model.getLanguageId(),resource:this._model.uri})?.enabled;return typeof e==`boolean`?e:this._themeService.getColorTheme().semanticHighlighting}_compute(e,t,n,r){let i=e&&this._getTokensAtPosition(e,r),a=t&&this._getSemanticTokenAtPosition(t,r),o=n&&this._getTreeSitterTokenAtPosition(n,r);if(!i&&!a&&!o){at(this._domNode,`No grammar or semantic tokens available.`);return}let s=i?.metadata,c=a?.metadata,l=a&&_n(this._model.getValueInRange(a.range)),u=i&&_n(this._model.getLineContent(r.lineNumber).substring(i.token.startIndex,i.token.endIndex)),d=l||u||``;if(at(this._domNode,Q(`h2.tiw-token`,void 0,d,Q(`span.tiw-token-length`,void 0,`${d.length} ${d.length===1?`char`:`chars`}`))),b(this._domNode,Q(`hr.tiw-metadata-separator`,{style:`clear:both`})),b(this._domNode,Q(`table.tiw-metadata-table`,void 0,Q(`tbody`,void 0,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`language`),Q(`td.tiw-metadata-value`,void 0,s?.languageId||``)),Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`standard token type`),Q(`td.tiw-metadata-value`,void 0,this._tokenTypeToString(s?.tokenType||D.Other))),...this._formatMetadata(c,s)))),a){b(this._domNode,Q(`hr.tiw-metadata-separator`));let e=b(this._domNode,Q(`table.tiw-metadata-table`,void 0)),t=b(e,Q(`tbody`,void 0,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`semantic token type`),Q(`td.tiw-metadata-value`,void 0,a.type))));if(a.modifiers.length&&b(t,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`modifiers`),Q(`td.tiw-metadata-value`,void 0,a.modifiers.join(` `)))),a.metadata){let e=[`foreground`,`bold`,`italic`,`underline`,`strikethrough`],n={},r=[];for(let t of e)if(a.metadata[t]!==void 0){let e=a.definitions[t],i=this._renderTokenStyleDefinition(e,t),o=i.map(e=>it(e)?e.outerHTML:e).join(),s=n[o];s||(n[o]=s=[],r.push([i,o])),s.push(t)}for(let[e,i]of r)b(t,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,n[i].join(`, `)),Q(`td.tiw-metadata-value`,void 0,...e)))}}if(i){let e=this._themeService.getColorTheme();b(this._domNode,Q(`hr.tiw-metadata-separator`));let t=b(this._domNode,Q(`table.tiw-metadata-table`)),n=b(t,Q(`tbody`));u&&u!==d&&b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`textmate token`),Q(`td.tiw-metadata-value`,void 0,`${u} (${u.length})`)));let r=[];for(let e=i.token.scopes.length-1;e>=0;e--)r.push(i.token.scopes[e]),e>0&&r.push(Q(`br`));b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`textmate scopes`),Q(`td.tiw-metadata-value.tiw-metadata-scopes`,void 0,...r)));let o=pn(e,i.token.scopes,!1),s=a?.metadata?.foreground;if(o){if(s!==i.metadata.foreground){let e=Q(`code.tiw-theme-selector`,void 0,o.rawSelector,Q(`br`),JSON.stringify(o.settings,null,`	`));s&&(e=Q(`s`,void 0,e)),b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`foreground`),Q(`td.tiw-metadata-value`,void 0,e)))}}else s||b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`foreground`),Q(`td.tiw-metadata-value`,void 0,`No theme selector`)))}if(o){let e=o[o.length-1];b(this._domNode,Q(`hr.tiw-metadata-separator`));let t=b(this._domNode,Q(`table.tiw-metadata-table`)),n=b(t,Q(`tbody`));b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`tree-sitter token ${e.id}`),Q(`td.tiw-metadata-value`,void 0,`${e.text}`)));let i=[],a=o.length-1,s=o[a];for(;s.parent||a>0;)i.push(s.type),s=s.parent??o[--a],s&&i.push(Q(`br`));b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`tree-sitter tree`),Q(`td.tiw-metadata-value.tiw-metadata-scopes`,void 0,...i)));let c=this._model.tokenization.tokens.get().tokenizationImpl.get(),l=c?.captureAtPosition(r.lineNumber,r.column);l&&l.length>0&&b(n,Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`foreground`),Q(`td.tiw-metadata-value`,void 0,l.map(e=>e.name).join(` `))))}}_formatMetadata(e,t){let n=[];function r(r){let i=e?.[r]||t?.[r];if(i!==void 0){let t=e?.[r]?`tiw-metadata-semantic`:``;n.push(Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,r),Q(`td.tiw-metadata-value.${t}`,void 0,i)))}return i}let i=r(`foreground`),a=r(`background`);if(i&&a){let e=T.fromHex(a),t=T.fromHex(i);e.isOpaque()?n.push(Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`contrast ratio`),Q(`td.tiw-metadata-value`,void 0,e.getContrastRatio(t.makeOpaque(e)).toFixed(2)))):n.push(Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`Contrast ratio cannot be precise for background colors that use transparency`),Q(`td.tiw-metadata-value`)))}let o=[];function s(n){let r;e&&e[n]?r=Q(`span.tiw-metadata-semantic`,void 0,n):t&&t[n]&&(r=n),r&&(o.length&&o.push(` `),o.push(r))}return s(`bold`),s(`italic`),s(`underline`),s(`strikethrough`),o.length&&n.push(Q(`tr`,void 0,Q(`td.tiw-metadata-key`,void 0,`font style`),Q(`td.tiw-metadata-value`,void 0,...o))),n}_decodeMetadata(e){let t=this._themeService.getColorTheme().tokenColorMap,n=O.getLanguageId(e),r=O.getTokenType(e),i=O.getFontStyle(e),a=O.getForeground(e),o=O.getBackground(e);return{languageId:this._languageService.languageIdCodec.decodeLanguageId(n),tokenType:r,bold:i&E.Bold?!0:void 0,italic:i&E.Italic?!0:void 0,underline:i&E.Underline?!0:void 0,strikethrough:i&E.Strikethrough?!0:void 0,foreground:t[a],background:t[o]}}_tokenTypeToString(e){switch(e){case D.Other:return`Other`;case D.Comment:return`Comment`;case D.String:return`String`;case D.RegEx:return`RegEx`;default:return`??`}}_getTokensAtPosition(e,t){let n=t.lineNumber,r=this._getStateBeforeLine(e,n),i=e.tokenizeLine(this._model.getLineContent(n),r),a=e.tokenizeLine2(this._model.getLineContent(n),r),o=0;for(let e=i.tokens.length-1;e>=0;e--){let n=i.tokens[e];if(t.column-1>=n.startIndex){o=e;break}}let s=0;for(let e=a.tokens.length>>>1;e>=0;e--)if(t.column-1>=a.tokens[e<<1]){s=e;break}return{token:i.tokens[o],metadata:this._decodeMetadata(a.tokens[(s<<1)+1])}}_getStateBeforeLine(e,t){let n=null;for(let r=1;r<t;r++){let t=e.tokenizeLine(this._model.getLineContent(r),n);n=t.ruleStack}return n}isSemanticTokens(e){return e&&e.data}async _computeSemanticTokens(e){if(!this._isSemanticColoringEnabled())return null;let t=this._languageFeaturesService.documentSemanticTokensProvider.ordered(this._model);if(t.length){let e=t[0],n=await Promise.resolve(e.provideDocumentSemanticTokens(this._model,null,this._currentRequestCancellationTokenSource.token));if(this.isSemanticTokens(n))return{tokens:n,legend:e.getLegend()}}let n=this._languageFeaturesService.documentRangeSemanticTokensProvider.ordered(this._model);if(n.length){let t=n[0],r=e.lineNumber,i=new S(r,1,r,this._model.getLineMaxColumn(r)),a=await Promise.resolve(t.provideDocumentRangeSemanticTokens(this._model,i,this._currentRequestCancellationTokenSource.token));if(this.isSemanticTokens(a))return{tokens:a,legend:t.getLegend()}}return null}_getSemanticTokenAtPosition(e,t){let n=e.tokens.data,r=this._model.getLanguageId(),i=0,a=0,o=t.lineNumber-1,s=t.column-1;for(let t=0;t<n.length;t+=5){let c=n[t],l=n[t+1],u=n[t+2],d=n[t+3],ee=n[t+4],f=i+c,p=c===0?a+l:l;if(o===f&&p<=s&&s<p+u){let t=e.legend.tokenTypes[d]||`not in legend (ignored)`,n=[],i=ee;for(let t=0;i>0&&t<e.legend.tokenModifiers.length;t++)i&1&&n.push(e.legend.tokenModifiers[t]),i>>=1;i>0&&n.push(`not in legend (ignored)`);let a=new S(f+1,p+1,f+1,p+1+u),o={},s=this._themeService.getColorTheme().tokenColorMap,c=this._themeService.getColorTheme(),l=c.getTokenStyleMetadata(t,n,r,!0,o),m;return l&&(m={languageId:void 0,tokenType:D.Other,bold:l?.bold,italic:l?.italic,underline:l?.underline,strikethrough:l?.strikethrough,foreground:s[l?.foreground||lt.None],background:void 0}),{type:t,modifiers:n,range:a,metadata:m,definitions:o}}i=f,a=p}return null}_walkTreeforPosition(e,t){let n=this._model.getOffsetAt(t);e.gotoFirstChild();let r=!1,i=null;do e.currentNode.startIndex<=n&&n<e.currentNode.endIndex?(r=!0,i=e.currentNode):r=!1;while(r?e.gotoFirstChild():e.gotoNextSibling());return i}_getTreeSitterTokenAtPosition(e,t){let n=[],r=e?.tree.get();for(;r;){let i=r.walk(),a=this._walkTreeforPosition(i,t);i.delete(),a?(n.push(a),e=e?.getInjectionTrees(a.startIndex,e.languageId),r=e?.tree.get()):r=void 0}return n.length>0?n:null}_renderTokenStyleDefinition(e,t){let n=[];if(e===void 0)return n;let r=this._themeService.getColorTheme();if(Array.isArray(e)){let i={};r.resolveScopes(e,i);let a=i[t];if(a&&i.scope){let e=Q(`ul.tiw-metadata-values`),t=Array.isArray(a.scope)?a.scope:[String(a.scope)];for(let n of t)e.appendChild(Q(`li.tiw-metadata-value.tiw-metadata-scopes`,void 0,n));return n.push(i.scope.join(` `),e,Q(`code.tiw-theme-selector`,void 0,JSON.stringify(a.settings,null,`	`))),n}return n}else if(Kt.is(e)){let i=r.getTokenStylingRuleScope(e);return i===`setting`?(n.push(`User settings: ${e.selector.id} - ${this._renderStyleProperty(e.style,t)}`),n):(i===`theme`&&n.push(`Color theme: ${e.selector.id} - ${this._renderStyleProperty(e.style,t)}`),n)}else{let i=r.resolveTokenStyleValue(e);return n.push(`Default: ${i?this._renderStyleProperty(i,t):``}`),n}}_renderStyleProperty(e,t){switch(t){case`foreground`:return e.foreground?T.Format.CSS.formatHexA(e.foreground,!0):``;default:return e[t]===void 0?``:String(e[t])}}getDomNode(){return this._domNode}getPosition(){return{position:this._editor.getPosition(),preference:[Ae.BELOW,Ae.ABOVE]}}};ze($.ID,$,Ie.Lazy),Re(gn),se(),te(async e=>{e.get(re).when(de.Ready).then(()=>{me.get(h)})});function yn(){return{...f(),[h.toString()]:new ft(J,[],!1)}}export{h as ITextMateTokenizationService,yn as default};